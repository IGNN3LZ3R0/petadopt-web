<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Restablecer ContraseÃ±a</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <h2>ğŸ” Restablecer contraseÃ±a</h2>

  <form id="resetForm">
    <input
      type="password"
      id="password"
      placeholder="Nueva contraseÃ±a"
      required
      minlength="6"
    />
    <input
      type="password"
      id="confirmPassword"
      placeholder="Confirmar contraseÃ±a"
      required
      minlength="6"
    />
    <button type="submit">Actualizar contraseÃ±a</button>
  </form>

  <p id="error" style="color:red;"></p>
  <p id="success" style="color:green;"></p>

  <script>
    // ğŸ”‘ SUPABASE CONFIG
    const SUPABASE_URL = 'https://kilsddvjbcugipxeajtz.supabase.co';
    const SUPABASE_KEY = 'TU_ANON_PUBLIC_KEY';

    const supabase = window.supabase.createClient(
      SUPABASE_URL,
      SUPABASE_KEY
    );

    // ğŸ”¥ 1. LEER TOKENS DESDE LA URL (#access_token)
    const hash = window.location.hash.substring(1);
    const params = new URLSearchParams(hash);

    const accessToken = params.get('access_token');
    const refreshToken = params.get('refresh_token');

    if (!accessToken || !refreshToken) {
      document.getElementById('error').textContent =
        'El enlace es invÃ¡lido o ha expirado. Solicita uno nuevo.';
    }

    // ğŸ”¥ 2. CREAR SESIÃ“N TEMPORAL (CLAVE)
    async function initSession() {
      const { error } = await supabase.auth.setSession({
        access_token: accessToken,
        refresh_token: refreshToken,
      });

      if (error) {
        document.getElementById('error').textContent = error.message;
      }
    }

    initSession();

    // ğŸ”¥ 3. ACTUALIZAR CONTRASEÃ‘A
    document.getElementById('resetForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const password = document.getElementById('password').value;
      const confirm = document.getElementById('confirmPassword').value;

      if (password !== confirm) {
        document.getElementById('error').textContent =
          'Las contraseÃ±as no coinciden';
        return;
      }

      const { error } = await supabase.auth.updateUser({
        password: password,
      });

      if (error) {
        document.getElementById('error').textContent = error.message;
        return;
      }

      document.getElementById('success').textContent =
        'âœ… ContraseÃ±a actualizada correctamente';

      // ğŸ”¥ 4. VOLVER A LA APP (DEEP LINK)
      setTimeout(() => {
        window.location.href = 'petadopt://auth/callback';
      }, 2000);
    });
  </script>
</body>
</html>
